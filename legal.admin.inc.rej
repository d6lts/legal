***************
*** 8,31 ****
  /**
   * Module settings form.
   */
- function legal_administration() {
    $conditions = legal_get_conditions();
  
- 	if (module_exists('locale')) {
- 		$languages = locale_language_list();
- 	  $language_default = language_default();
- 	  $language = $language_default->language;
- 		//$language = empty($conditions['language']) ? $language_default->language : $conditions['language'];
- 		$version_options = array('version' => t('All users (new version)'), 'revision' => t('Language specific users (a revision)'));
- 		$version_handling = 'version';
- 	}
- 	else {
- 		$languages = array('en' => t('English'));
- 		$language = 'en';
- 		$version_handling = 'version';
- 	}
   
-   $form = legal_display_fields($conditions);
  
    $form['conditions'] = array(
      '#type' => 'textarea',
--- 8,31 ----
  /**
   * Module settings form.
   */
+ function legal_administration($form) {
    $conditions = legal_get_conditions();
  
+   if (module_exists('locale')) {
+     $languages = locale_language_list();
+     $language_default = language_default();
+     $language = $language_default->language;
+     //$language = empty($conditions['language']) ? $language_default->language : $conditions['language'];
+     $version_options = array('version' => t('All users (new version)'), 'revision' => t('Language specific users (a revision)'));
+     $version_handling = 'version';
+   }
+   else {
+     $languages = array('en' => t('English'));
+     $language = 'en';
+     $version_handling = 'version';
+   }
   
+   $form = array_merge($form, legal_display_fields($conditions));
  
    $form['conditions'] = array(
      '#type' => 'textarea',
***************
*** 48,84 ****
      '#required' => TRUE,
    );
    
- 	// only display options if there's more than one language available
- 	if (count($languages) > 1) {
- 	  // Language and version handling options
- 	  $form['language'] = array(
- 	    '#type' => 'fieldset',
- 	    '#title' => t('Language'),
- 	    '#collapsible' => TRUE,
- 	    '#collapsed' => TRUE,
- 	  );
- 
- 		$form['language']['language'] = array(
- 		  '#type' => 'select',
- 		  '#title' => t('Language'),
- 		  '#options' => $languages,
- 		  '#default_value' => $language,
- 		);
- 
- 		$form['language']['version_handling'] = array(
- 		  '#type' => 'select',
- 		  '#title' => t('Ask To Re-accept'),
- 	    '#description' => t('<strong>All users</strong>: all users will be asked to accept the new version of the T&C, including users who accepted a previous version.<br />
- 													 <strong>Language specific</strong>: only new users, and users who accepted the T&C in the same language as this new revision will be asked to re-accept.'),
- 		  '#options' => $version_options,
- 		  '#default_value' => $version_handling,
- 		); 
- 	}
- 	else {
- 		$form['language']['language'] = array('#type' => 'value', '#value' => $language);
- 		$form['language']['version_handling'] = array('#type' => 'value', '#value' => $version_handling);
- 		 
- 	}
  
  
    // Additional checkboxes.
--- 48,84 ----
      '#required' => TRUE,
    );
    
+   // Only display options if there's more than one language available.
+   if (count($languages) > 1) {
+     // Language and version handling options.
+     $form['language'] = array(
+       '#type' => 'fieldset',
+       '#title' => t('Language'),
+       '#collapsible' => TRUE,
+       '#collapsed' => TRUE,
+     );
+ 
+     $form['language']['language'] = array(
+       '#type' => 'select',
+       '#title' => t('Language'),
+       '#options' => $languages,
+       '#default_value' => $language,
+     );
+ 
+     $form['language']['version_handling'] = array(
+       '#type' => 'select',
+       '#title' => t('Ask To Re-accept'),
+       '#description' => t('<strong>All users</strong>: all users will be asked to accept the new version of the T&C, including users who accepted a previous version.<br />
+                            <strong>Language specific</strong>: only new users, and users who accepted the T&C in the same language as this new revision will be asked to re-accept.'),
+       '#options' => $version_options,
+       '#default_value' => $version_handling,
+     ); 
+   }
+   else {
+     $form['language']['language'] = array('#type' => 'value', '#value' => $language);
+     $form['language']['version_handling'] = array('#type' => 'value', '#value' => $version_handling);
+      
+   }
  
  
    // Additional checkboxes.
***************
*** 148,167 ****
      case 1: // scroll box (CSS)
      case 2: // HTML
        $form['legal']['conditions'] = array(
-         '#value' => filter_xss_admin($form['conditions']['#value']),
        );
        $form['legal']['legal_accept']['#title'] = t('<strong>Accept</strong> Terms & Conditions of Use');
        break;
      case 3: // Page Link
        $form['legal']['conditions'] = array(
-         '#value' => ' ',
        );
        $form['legal']['legal_accept']['#title'] = t('<strong>Accept</strong> <a href="@terms">Terms & Conditions</a> of Use', array('@terms' => url('legal')));
        break;
      default: // scroll box (HTML)
        $form['legal']['conditions'] = array(
- 				'#id' => 'preview',
- 				'#name' => 'preview',
          '#type' => 'textarea',
          '#title' => t('Terms & Conditions'),
          '#value' => $form['conditions']['#value'],
--- 148,167 ----
      case 1: // scroll box (CSS)
      case 2: // HTML
        $form['legal']['conditions'] = array(
+         '#markup' => filter_xss_admin($form['conditions']['#value']),
        );
        $form['legal']['legal_accept']['#title'] = t('<strong>Accept</strong> Terms & Conditions of Use');
        break;
      case 3: // Page Link
        $form['legal']['conditions'] = array(
+         '#value' => '',
        );
        $form['legal']['legal_accept']['#title'] = t('<strong>Accept</strong> <a href="@terms">Terms & Conditions</a> of Use', array('@terms' => url('legal')));
        break;
      default: // scroll box (HTML)
        $form['legal']['conditions'] = array(
+         '#id' => 'preview',
+         '#name' => 'preview',
          '#type' => 'textarea',
          '#title' => t('Terms & Conditions'),
          '#value' => $form['conditions']['#value'],
***************
*** 210,217 ****
    // If new conditions are different from current permisions, enter in database.
    if (legal_conditions_updated($values)) {
      $version = legal_version($values['version_handling'], $values['language']);
-     db_query("INSERT INTO {legal_conditions} (tc_id, version, revision, language, conditions, date, extras, changes) VALUES (NULL, %d, %d, '%s', '%s', %d, '%s', '%s')", $version['version'], $version['revision'], $values['language'], $values['conditions'], time(), serialize($values['extras']), $values['changes']);
-     drupal_set_message (t('Terms & Conditions have been saved.'));
    }
  
    // Empty all cache.
--- 203,220 ----
    // If new conditions are different from current permisions, enter in database.
    if (legal_conditions_updated($values)) {
      $version = legal_version($values['version_handling'], $values['language']);
+     db_insert('legal_conditions')
+       ->fields(array(
+         'version' => $version['version'],
+         'revision' => $version['revision'],
+         'language' => $values['language'],
+         'conditions' => $values['conditions'],
+         'date' => time(),
+         'extras' => serialize($values['extras']),
+         'changes' => $values['changes'],
+       ))
+       ->execute();
+     drupal_set_message(t('Terms & Conditions have been saved.'));
    }
  
    // Empty all cache.
***************
*** 219,236 ****
    cache_clear_all();
  }
  
- function theme_legal_administration($form) {
- 	$language = '';
- 	
    if (empty($form['current_id']['#value'])) {
      $output = '<p><strong>' .t('Terms & Conditions will not be shown to users, as no T&C have been saved.') . '</strong></p>';
    }
    else {
- 		if (module_exists('locale')) {
- 			$languages = locale_language_list();
- 	    $language = $form['language_value']['#value'];
- 			$language = check_plain($languages[$language]);
- 		}
  
      $output = '<h4>'. t('Most Recent Version/Revision') .'</h4>';
      $output .= '<p><strong>'. t('Version ID:') .'</strong> '. $form['current_id']['#value'] .'<br />';
--- 222,241 ----
    cache_clear_all();
  }
  
+ function theme_legal_administration($variables) {
+   $form = $variables['form'];
+ 
+   $language = '';
+   
    if (empty($form['current_id']['#value'])) {
      $output = '<p><strong>' .t('Terms & Conditions will not be shown to users, as no T&C have been saved.') . '</strong></p>';
    }
    else {
+     if (module_exists('locale')) {
+       $languages = locale_language_list();
+       $language = $form['language_value']['#value'];
+       $language = check_plain($languages[$language]);
+     }
  
      $output = '<h4>'. t('Most Recent Version/Revision') .'</h4>';
      $output .= '<p><strong>'. t('Version ID:') .'</strong> '. $form['current_id']['#value'] .'<br />';
***************
*** 240,265 ****
    }
  
    // Preview.
-   if (empty($form['legal']['conditions']['#value'])) {
-     drupal_render($form['legal']);
    }
    else {
-     $form = theme('legal_display', $form);
      $output .= '<div id="preview">';
      $output .= '<h3>'. t('Preview') .'</h3>';
      $output .= drupal_render($form['legal']);
      $output .= '</div>';
    }
  
- 	$output .= '<h4>'. t('Create New Version / Translation') .'</h4>'; 
-   $output .= drupal_render($form);
  
    return $output;
  }
  
  function legal_conditions_updated($new) {
    $previous_same_language = legal_get_conditions($new['language']);
- 	$previous = legal_get_conditions();
  
    if (($previous_same_language['conditions'] != $new['conditions']) && ($previous['conditions'] != $new['conditions'])) {
      return TRUE;
--- 245,270 ----
    }
  
    // Preview.
+   if (empty($form['legal']['conditions']['#markup'])) {
+     $output .= drupal_render($form['legal']);
    }
    else {
+     $form = theme('legal_display', array('form' => $form));
      $output .= '<div id="preview">';
      $output .= '<h3>'. t('Preview') .'</h3>';
      $output .= drupal_render($form['legal']);
      $output .= '</div>';
    }
  
+   $output .= '<h4>'. t('Create New Version / Translation') .'</h4>'; 
+   $output .= drupal_render_children($form);
  
    return $output;
  }
  
  function legal_conditions_updated($new) {
    $previous_same_language = legal_get_conditions($new['language']);
+   $previous = legal_get_conditions();
  
    if (($previous_same_language['conditions'] != $new['conditions']) && ($previous['conditions'] != $new['conditions'])) {
      return TRUE;
***************
*** 283,304 ****
   */
  function legal_version($version_handling, $language) {
  
-   $version = db_result(db_query_range("SELECT version FROM {legal_conditions} ORDER BY version DESC", 0, 1)); 
- 	
- 	// make new version
- 	if ($version_handling == 'version') {
- 		$versioning['version'] = empty($version) ? 1 : $version + 1;
- 		$versioning['revision'] = 1;
- 	}
- 	
- 	// make new revision
- 	if ($version_handling == 'revision') {
- 		$revision = db_result(db_query_range("SELECT revision FROM {legal_conditions} WHERE version = %d AND language = '%s' ORDER BY revision DESC", $version, $language, 0, 1));
- 		$versioning['version'] = $version; 
- 		$versioning['revision'] = empty($revision) ? 1 : $revision + 1;
- 	}
- 
- 	return $versioning;
  }
  
  /**
--- 288,319 ----
   */
  function legal_version($version_handling, $language) {
  
+   $version = db_select('legal_conditions', 'lc')
+     ->fields('lc', array('version'))
+     ->orderBy('version', 'desc')
+     ->range(0, 1)
+     ->execute()
+     ->fetchField();
+ 
+   // make new version
+   if ($version_handling == 'version') {
+     $versioning['version'] = empty($version) ? 1 : $version + 1;
+     $versioning['revision'] = 1;
+   }
+   
+   // make new revision
+   if ($version_handling == 'revision') {
+     $revision = db_select('legal_conditions', 'lc')
+       ->condition('version', $version)
+       ->condition('language', $language)
+       ->orderBy('revision', 'DESC')
+       ->execute()
+       ->fetchField();
+     $versioning['version'] = $version; 
+     $versioning['revision'] = empty($revision) ? 1 : $revision + 1;
+   }
+ 
+   return $versioning;
  }
  
  /**
***************
*** 307,367 ****
  function legal_languages() {
  
    $latest_header = array(t('Language'), t('Version'), t('Revision'));
- 	$latest_rows = legal_versions_latest_get();
- 	$rows = array();
- 	
- 	foreach ($latest_rows as $language_name => $language) {
- 		$row = array();
- 		$row[] = check_plain($language_name);
- 		$row[] = empty($language['version']) ? '-' : $language['version'];
- 		$row[] = empty($language['revision']) ? '-' : $language['revision']; 
- 		$rows[] = $row; 
- 	}
- 
- 	$form['latest'] = array(
- 	  '#type' => 'fieldset',
- 	  '#title' => t('Latest Version'),
- 	);
- 
- 	$form['latest']['#value'] = theme('table', $latest_header, $rows); 
- 
- 	return $form;
  }
  
   /**
    * Get latest version for each language.
    */
  function legal_versions_latest_get($language = NULL) {
- 	$conditions = array();
- 	$current_version = db_result(db_query_range('SELECT version FROM {legal_conditions} ORDER BY version DESC', 0, 1));
- 
- 	// get latest version for each language
- 	if (empty($language)) {
- 		$languages = locale_language_list(); 
- 			
- 		foreach ($languages as $language_id => $language_name) {
- 			$row = db_fetch_object(db_query_range("SELECT * FROM {legal_conditions} WHERE version = %d AND language = '%s' ORDER BY revision DESC", $current_version, $language_id, 0, 1));
        $conditions[$language_name] = legal_versions_latest_get_data($row);
- 		}
- 		
- 	} // get latest version for specific language 
- 	else {
- 		$row = db_fetch_object(db_query_range("SELECT * FROM {legal_conditions} WHERE language = '%s' GROUP BY language ORDER BY version DESC", $language, 0, 1));
      $conditions[$language] = legal_versions_latest_get_data($row); 
- 	}
- 	
- 	return $conditions;
  }
  
  function legal_versions_latest_get_data($data) {
    $row['version'] = isset($data->version) ? $data->version : '';
- 	$row['revision'] = isset($data->revision) ? $data->revision : '';  
- 	$row['language'] = isset($data->language) ? $data->language : '';  
- 	$row['conditions'] = isset($data->conditions) ? $data->conditions : '';  
- 	$row['date'] = isset($data->date) ? $data->date : '';  
- 	$row['extras'] = isset($data->extras) ? $data->extras : '';  
- 	$row['changes'] = isset($data->changes) ? $data->changes : '';
- 	return $row;
  
  
  
--- 322,404 ----
  function legal_languages() {
  
    $latest_header = array(t('Language'), t('Version'), t('Revision'));
+   $latest_rows = legal_versions_latest_get();
+   $rows = array();
+   
+   foreach ($latest_rows as $language_name => $language) {
+     $row = array();
+     $row[] = check_plain($language_name);
+     $row[] = empty($language['version']) ? '-' : $language['version'];
+     $row[] = empty($language['revision']) ? '-' : $language['revision']; 
+     $rows[] = $row; 
+   }
+ 
+   $form['latest'] = array(
+     '#type' => 'fieldset',
+     '#title' => t('Latest Version'),
+   );
+ 
+   $form['latest']['#value'] = theme('table', array('header' => $latest_header, 'rows' => $rows)); 
+ 
+   return $form;
  }
  
   /**
    * Get latest version for each language.
    */
  function legal_versions_latest_get($language = NULL) {
+   $conditions = array();
+   $current_version = db_select('legal_conditions', 'lc')
+     ->fields('lc', array('version'))
+     ->orderBy('version', 'DESC')
+     ->range(0, 1)
+     ->execute()
+     ->fetchField();
+ 
+ 
+   // get latest version for each language
+   if (empty($language)) {
+     $languages = locale_language_list(); 
+       
+     foreach ($languages as $language_id => $language_name) {
+       $result = db_select('legal_conditions', 'lc')
+         ->fields('lc')
+         ->condition('version', $current_version)
+         ->condition('language', $language_id)
+         ->orderBy('revision', 'DESC')
+         ->range(0, 1)
+         ->execute()
+         ->fetchAllAssoc('lc_id');
+       $row = count($result) ? (object) array_shift($result) : FALSE;
        $conditions[$language_name] = legal_versions_latest_get_data($row);
+     }
+     
+   } // get latest version for specific language 
+   else {
+     $result = db_select('legal_conditions', 'lc')
+       ->fields('lc')
+       ->condition('language', $language)
+       ->groupBy('language')
+       ->orderBy('version', 'DESC')
+       ->range(0, 1)
+       ->execute()
+       ->fetchAllAssoc('lc_id');
+     $row = count($result) ? (object) array_shift($result) : FALSE;
      $conditions[$language] = legal_versions_latest_get_data($row); 
+   }
+   
+   return $conditions;
  }
  
  function legal_versions_latest_get_data($data) {
    $row['version'] = isset($data->version) ? $data->version : '';
+   $row['revision'] = isset($data->revision) ? $data->revision : '';  
+   $row['language'] = isset($data->language) ? $data->language : '';  
+   $row['conditions'] = isset($data->conditions) ? $data->conditions : '';  
+   $row['date'] = isset($data->date) ? $data->date : '';  
+   $row['extras'] = isset($data->extras) ? $data->extras : '';  
+   $row['changes'] = isset($data->changes) ? $data->changes : '';
+   return $row;
  
  
  
